name: æ¯å¤©è¿æ‰§ä¸€æ¬¡nextjså’Œnode

on:
  workflow_dispatch: 
  # schedule:
  #  - cron: "0 0 * * *"

env:  
  TZ: Asia/Shanghai

permissions:
  contents: write
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. æ£€å‡ºä¸»ä»“åº“
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # 2. ç¯å¢ƒå‡†å¤‡
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # 3. è¿è¡Œ Next.js (Standalone æ¨¡å¼)
      - name: ä¸‹è½½ rendie-nextjs
        uses: actions/checkout@v4
        with:
          repository: rendie-com/rendie-nextjs
          token: ${{ secrets.MY_PAT }}
          path: rendie-nextjs
          fetch-depth: 1

      - name: å¯åŠ¨ Next.js
        run: |   
          cd ./rendie-nextjs/
          pnpm i
          pnpm run dev & 
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PROXY_URL: ${{ secrets.PROXY_URL }}
          NEXTJS_CONFIG_DEFAULT_DB: ${{ secrets.NEXTJS_CONFIG_DEFAULT_DB }}  
          NEXTJS_CONFIG_PG01: ${{ secrets.NEXTJS_CONFIG_PG01 }}  
          NEXTJS_CONFIG_PG02: ${{ secrets.NEXTJS_CONFIG_PG02 }} 
          NEXTJS_CONFIG_SQLITE: ${{ secrets.NEXTJS_CONFIG_SQLITE }} 

      # 4. ç³»ç»Ÿå­—ä½“å®‰è£…
      - name: å®‰è£…æ–‡æ³‰é©¿å­—ä½“
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends ttf-wqy-zenhei

      # 5. ä¸‹è½½ä¸šåŠ¡ä»“åº“
      - name: ä¸‹è½½ä¾èµ–ä»“åº“
        run: |        
          git clone --depth 1 https://github.com/rendie-com/rendie-chrome -b main ./rendie-chrome   
          git clone --depth 1 https://github.com/rendie-com/rendie-node -b main ./rendie-node
          
      # 6. è¿è¡Œ Node ä¸šåŠ¡é€»è¾‘
      - name: è¿è¡Œ node è„šæœ¬      
        run: |
          mkdir -p ./sqlite3/error/         
          cd ./rendie-node/rendie-sqlite3-shopee-marketing/
          pnpm install --no-frozen-lockfile
          node 1day.js          
        env:
          NODE_SHOPEE_ACCESS_TOKEN: ${{ secrets.NODE_SHOPEE_ACCESS_TOKEN }}  
          NODE_SHOPEE_REFRESH_TOKEN: ${{ secrets.NODE_SHOPEE_REFRESH_TOKEN }}
          
      # 7. éƒ¨ç½²åˆ° main åˆ†æ”¯ ğŸš€
      - name: Deploy to Main ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: sqlite3
          branch: main
          target-folder: sqlite3
          commit-message: "data: è‡ªåŠ¨æ›´æ–°æ•°æ®å¹¶ä¿ç•™æºç  [skip ci]" # ğŸ‘ˆ å¿…é¡»å¸¦ [skip ci] é˜²æ­¢æ­»å¾ªç¯

      # 8. è‡ªåŠ¨æ¸…ç†è¿è¡Œè®°å½•
      - name: åˆ é™¤è¿è¡Œè®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 0
